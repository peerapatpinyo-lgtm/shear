# report_generator.py
# Version: 5.0 (Native Streamlit Mode - Guaranteed to work)
import streamlit as st
from datetime import datetime

def render_report_tab(beam_data, conn_data):
    # --- 1. ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÅ‡∏•‡∏∞ Input ---
    st.markdown("## üìë ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á (Structural Report)")
    st.info("‚ÑπÔ∏è ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (Native) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡πÅ‡∏•‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î")

    with st.expander("üìù ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£", expanded=True):
        c1, c2 = st.columns(2)
        with c1:
            project_name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£", value="‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏•‡∏≠‡∏¢‡πÇ‡∏Å‡∏î‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
            owner_name = st.text_input("‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£", value="‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏™‡∏¢‡∏≤‡∏°‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏° ‡∏à‡∏≥‡∏Å‡∏±‡∏î")
        with c2:
            engineer_name = st.text_input("‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö", value="‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ (‡∏™‡∏¢. 12345)")
            doc_no = st.text_input("‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£", value="CALC-2024-001")

    if not beam_data:
        st.warning("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà Tab 1 ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö")
        return

    # --- 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
    # ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
    sec_name = beam_data.get('sec_name', '-')
    span = beam_data.get('user_span', 0)
    fy = beam_data.get('Fy', 0)
    
    m_act = beam_data.get('m_act', 0)
    m_cap = beam_data.get('mn', 0)
    ratio_m = beam_data.get('ratio_m', 0)

    v_act = beam_data.get('v_act', 0)
    v_cap = beam_data.get('vn', 0)
    ratio_v = beam_data.get('ratio_v', 0)

    d_act = beam_data.get('defl_act', 0)
    d_all = beam_data.get('defl_all', 0)
    ratio_d = beam_data.get('ratio_d', 0)

    # ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    max_ratio = max(ratio_m, ratio_v, ratio_d)
    is_pass = max_ratio <= 1.0
    curr_date = datetime.now().strftime("%d/%m/") + str(datetime.now().year + 543)

    st.markdown("---")

    # --- 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö Native (‡πÑ‡∏°‡πà‡∏°‡∏µ HTML Injection) ---
    
    # ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
    st.header(f"üèóÔ∏è {project_name}")
    st.markdown(f"**‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô:** {owner_name} | **‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£:** {engineer_name}")
    st.markdown(f"**‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:** {doc_no} | **‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:** {curr_date}")

    st.markdown("### 1. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Status)")
    
    if is_pass:
        st.success(f"### ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / APPROVED\n**‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢** (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏õ {max_ratio*100:.0f}% ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)")
    else:
        st.error(f"### ‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / REJECTED\n**‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå** ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏´‡∏•‡πá‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏¢‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏≤‡∏î")

    st.markdown("### 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö (Design Data)")
    c_data1, c_data2, c_data3 = st.columns(3)
    c_data1.metric("‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏´‡∏•‡πá‡∏Å (Section)", str(sec_name))
    c_data2.metric("‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏´‡∏•‡πá‡∏Å (Fy)", f"{fy:,} ksc")
    c_data3.metric("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏≤‡∏ô (Span)", f"{span} m.")

    st.markdown("### 3. ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Analysis Results)")
    
    # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    results = [
        {
            "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö": "1. ‡πÇ‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏î‡∏±‡∏î (Moment)",
            "‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î (Demand)": f"{m_act:,.0f} kg-m",
            "‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ (Capacity)": f"{m_cap:,.0f} kg-m",
            "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô (Ratio)": f"{ratio_m:.2f}",
            "‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå": "‚úÖ ‡∏ú‡πà‡∏≤‡∏ô" if ratio_m <= 1 else "‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô"
        },
        {
            "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö": "2. ‡πÅ‡∏£‡∏á‡πÄ‡∏â‡∏∑‡∏≠‡∏ô (Shear)",
            "‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î (Demand)": f"{v_act:,.0f} kg",
            "‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ (Capacity)": f"{v_cap:,.0f} kg",
            "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô (Ratio)": f"{ratio_v:.2f}",
            "‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå": "‚úÖ ‡∏ú‡πà‡∏≤‡∏ô" if ratio_v <= 1 else "‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô"
        },
        {
            "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö": "3. ‡∏Å‡∏≤‡∏£‡πÅ‡∏≠‡πà‡∏ô‡∏ï‡∏±‡∏ß (Deflection)",
            "‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î (Demand)": f"{d_act:.2f} cm",
            "‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ (Capacity)": f"{d_all:.2f} cm",
            "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô (Ratio)": f"{ratio_d:.2f}",
            "‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå": "‚úÖ ‡∏ú‡πà‡∏≤‡∏ô" if ratio_d <= 1 else "‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô"
        }
    ]
    st.table(results)

    # ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≠
    st.markdown("### 4. ‡∏ö‡∏ó‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥")
    conn_summ = conn_data.get('summary', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≠')
    
    if is_pass:
        st.info(f"**‡∏ö‡∏ó‡∏™‡∏£‡∏∏‡∏õ:** ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö\n\n**‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≠:** {conn_summ}")
    else:
        st.warning(f"**‡∏ö‡∏ó‡∏™‡∏£‡∏∏‡∏õ:** ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö\n\n**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:** ‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î")

    st.markdown("---")
    
    # ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ Column)
    st.markdown("#### ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏ú‡∏• (Certification)")
    col_sign1, col_sign2 = st.columns(2)
    
    with col_sign1:
        st.markdown("<br><br>__________________________", unsafe_allow_html=True)
        st.markdown(f"**{engineer_name}**")
        st.caption("‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö (Structural Engineer)")
        
    with col_sign2:
        st.markdown("<br><br>__________________________", unsafe_allow_html=True)
        st.markdown("**‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö**")
        st.caption("(Approved By)")

    # ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ Footer
    st.caption(f"Generated by Beam Insight | {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
